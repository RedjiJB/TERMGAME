mission:
  id: "linux/week14/scp-sftp-intermediate"
  title: "Secure File Transfer with SCP and SFTP"
  difficulty: intermediate
  description: "Master secure file transfer using SCP and SFTP protocols"
  estimated_time: 35
  tags:
    - linux
    - scp
    - sftp
    - file-transfer
    - intermediate
    - week14
    - cst8207

environment:
  image: "ubuntu:22.04"
  workdir: "/home/learner"
  setup:
    - "apt-get update -qq && apt-get install -y -qq openssh-client openssh-server"
    - "service ssh start"
    - "useradd -m -s /bin/bash fileserver"
    - "echo 'fileserver:password123' | chpasswd"
    - "mkdir -p /home/fileserver/{uploads,downloads,shared}"
    - "chown -R fileserver:fileserver /home/fileserver"
    - |
      # Create test files
      echo "This is a test document" > /home/learner/document.txt
      echo "Configuration data" > /home/learner/config.conf
      dd if=/dev/zero of=/home/learner/largefile.bin bs=1M count=5 2>/dev/null
    - |
      # Create directory structure
      mkdir -p /home/learner/project/{src,docs,tests}
      echo "# README" > /home/learner/project/README.md
      echo "def main(): pass" > /home/learner/project/src/main.py
      echo "# Tests" > /home/learner/project/tests/test_main.py
    - "mkdir -p /home/learner/.ssh"
    - "chmod 700 /home/learner/.ssh"
    - "ssh-keygen -t ed25519 -N '' -f /home/learner/.ssh/id_ed25519 -C 'learner@termgame'"
    - "mkdir -p /home/fileserver/.ssh"
    - "cat /home/learner/.ssh/id_ed25519.pub > /home/fileserver/.ssh/authorized_keys"
    - "chmod 700 /home/fileserver/.ssh"
    - "chmod 600 /home/fileserver/.ssh/authorized_keys"
    - "chown -R fileserver:fileserver /home/fileserver/.ssh"

steps:
  - id: "understand-scp"
    title: "Introduction to SCP"
    description: |
      **SCP: Secure Copy Protocol**

      SCP copies files securely over SSH.

      **Key features:**
      - Encrypted transfer (uses SSH)
      - Simple syntax (like cp)
      - Fast and efficient
      - Works with SSH keys
      - No interactive shell

      **Basic syntax:**

      Copy TO remote:
      scp local_file user@host:/remote/path

      Copy FROM remote:
      scp user@host:/remote/file local_path

      **Examples:**

      Upload file:
      scp document.txt user@server:/home/user/

      Download file:
      scp user@server:/var/log/app.log ./

      Specify port:
      scp -P 2222 file user@host:/path

      Use specific key:
      scp -i ~/.ssh/key file user@host:/path

      **SCP vs CP:**

      Local copy:
      cp file.txt /destination/

      Remote copy:
      scp file.txt user@host:/destination/

      Almost identical syntax!

      **Test SCP:**
      scp -o StrictHostKeyChecking=no document.txt fileserver@localhost:/home/fileserver/uploads/

      Verify:
      ssh fileserver@localhost 'ls -la /home/fileserver/uploads/'

      Should show document.txt copied!
    hint: "Use scp localfile user@host:/remote/path"
    validation:
      type: "command-output"
      command: "scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /home/learner/document.txt fileserver@localhost:/home/fileserver/uploads/ 2>/dev/null && ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null fileserver@localhost 'ls /home/fileserver/uploads/document.txt' 2>/dev/null"
      matcher: "contains"
      expected: "document.txt"

  - id: "scp-directories"
    title: "Copy Directories with SCP"
    description: |
      **Recursive Copy with -r:**

      Copy entire directories:
      scp -r directory/ user@host:/path/

      **Examples:**

      Upload directory:
      scp -r project/ user@server:/home/user/

      Download directory:
      scp -r user@server:/var/www/ ./

      **Important:**
      - Preserves directory structure
      - Copies all subdirectories and files
      - Maintains permissions (mostly)

      **Preserve attributes with -p:**
      scp -rp directory/ user@host:/path/

      -p preserves:
      - Modification times
      - Access times
      - Permission modes

      **Verbose mode -v:**
      scp -rv directory/ user@host:/path/

      Shows each file being copied.

      **Common options:**
      -r    Recursive (directories)
      -p    Preserve attributes
      -v    Verbose
      -C    Compression
      -P    Port (capital P!)
      -i    Identity file (key)
      -q    Quiet mode

      **Practice:**

      Copy project directory to remote:
      scp -r -o StrictHostKeyChecking=no project/ fileserver@localhost:/home/fileserver/uploads/

      Verify structure:
      ssh fileserver@localhost 'ls -R /home/fileserver/uploads/project/'

      Should show all subdirectories and files!

      **Download from remote:**
      scp -r fileserver@localhost:/home/fileserver/uploads/project/ /tmp/downloaded_project/

      Check:
      ls -R /tmp/downloaded_project/

      **Tip:** Trailing slash matters!
      scp -r dir/ user@host:/dest/    # Copies contents of dir
      scp -r dir user@host:/dest/     # Copies dir itself
    hint: "Use -r flag for recursive directory copy"
    validation:
      type: "command-output"
      command: "scp -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /home/learner/project fileserver@localhost:/home/fileserver/uploads/ 2>/dev/null && ssh -o StrictHostKeyChecking=no fileserver@localhost 'find /home/fileserver/uploads/project -type f | wc -l' 2>/dev/null"
      matcher: "regex"
      expected: "[2-9]"

  - id: "scp-wildcards"
    title: "Using Wildcards with SCP"
    description: |
      **Wildcards in SCP:**

      Copy multiple files matching pattern.

      **Local wildcards (simple):**
      scp *.txt user@host:/path/

      Uploads all .txt files.

      **Remote wildcards (needs quotes):**
      scp 'user@host:/path/*.txt' ./

      Downloads all .txt files.

      **Why quotes for remote?**
      Without quotes: Shell expands locally (wrong!)
      With quotes: Server expands remotely (correct!)

      **Examples:**

      Upload all configs:
      scp *.conf user@server:/etc/app/

      Upload specific pattern:
      scp file_*.txt user@server:/backup/

      Download logs:
      scp 'user@server:/var/log/app*.log' ./logs/

      **Multiple files explicitly:**
      scp file1.txt file2.txt file3.txt user@host:/dest/

      **Combining with paths:**
      scp src/*.py user@host:/app/src/
      scp tests/test_*.py user@host:/app/tests/

      **Practice:**

      Create test files:
      touch test1.txt test2.txt test3.txt

      Upload all test files:
      scp -o StrictHostKeyChecking=no test*.txt fileserver@localhost:/home/fileserver/uploads/

      Verify:
      ssh fileserver@localhost 'ls /home/fileserver/uploads/test*.txt'

      Download them back:
      scp 'fileserver@localhost:/home/fileserver/uploads/test*.txt' /tmp/

      Check:
      ls /tmp/test*.txt

      **Note on complex patterns:**

      Works:
      scp *.{txt,conf} user@host:/path/

      Careful with:
      scp **/*.txt user@host:/path/    # Requires bash globstar

      **Best practice:**
      For complex patterns, use tar + ssh or rsync instead.
    hint: "Quote wildcards for remote expansion: 'user@host:*.txt'"
    validation:
      type: "command-output"
      command: "touch /home/learner/test{1,2,3}.txt && scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /home/learner/test*.txt fileserver@localhost:/home/fileserver/uploads/ 2>/dev/null && ssh -o StrictHostKeyChecking=no fileserver@localhost 'ls /home/fileserver/uploads/test*.txt | wc -l' 2>/dev/null"
      matcher: "contains"
      expected: "3"

  - id: "understand-sftp"
    title: "Introduction to SFTP"
    description: |
      **SFTP: SSH File Transfer Protocol**

      Interactive file transfer over SSH (not FTP over SSH!).

      **SFTP vs SCP:**

      | Feature | SCP | SFTP |
      |---------|-----|------|
      | Interactive | No | Yes |
      | Resume transfers | No | Yes |
      | Directory browsing | No | Yes |
      | File management | No | Yes (rm, mkdir, etc.) |
      | Speed | Faster | Slightly slower |

      **When to use:**
      - SCP: Quick file copies, scripts
      - SFTP: Interactive sessions, file management

      **Connect to SFTP:**
      sftp user@hostname

      You get an interactive prompt:
      sftp>

      **Basic SFTP commands:**

      Navigation:
      pwd         # Remote working directory
      lpwd        # Local working directory
      ls          # List remote files
      lls         # List local files
      cd dir      # Change remote directory
      lcd dir     # Change local directory

      Transfer:
      get file    # Download file
      put file    # Upload file
      mget *.txt  # Download multiple
      mput *.txt  # Upload multiple

      Management:
      mkdir dir   # Create remote directory
      rmdir dir   # Remove remote directory
      rm file     # Delete remote file
      rename old new  # Rename remote file

      Exit:
      bye         # Exit SFTP
      exit        # Exit SFTP
      quit        # Exit SFTP

      **Example session:**
      ```
      $ sftp user@server
      sftp> ls
      sftp> cd documents
      sftp> get report.pdf
      sftp> lcd ~/Downloads
      sftp> put presentation.pptx
      sftp> bye
      ```

      **Non-interactive SFTP:**

      Batch mode:
      sftp -b commands.txt user@host

      Single command:
      echo "get file.txt" | sftp user@host

      **Practice (interactive):**
      sftp -o StrictHostKeyChecking=no fileserver@localhost

      Try these commands:
      sftp> pwd
      sftp> ls
      sftp> cd uploads
      sftp> ls
      sftp> get document.txt
      sftp> bye

      Document should now be in current directory!
    hint: "Use sftp user@host for interactive file transfer"
    validation:
      type: "command-output"
      command: "echo 'ls' | sftp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null fileserver@localhost 2>/dev/null | grep -i 'sftp\\|uploads\\|downloads'"
      matcher: "contains"
      expected: ""

  - id: "sftp-batch-mode"
    title: "SFTP Batch Mode and Automation"
    description: |
      **Automate SFTP with Batch Files:**

      Create script with SFTP commands, execute non-interactively.

      **Create batch file:**
      cat > sftp_commands.txt << 'EOF'
      cd uploads
      put document.txt
      put config.conf
      mkdir backup
      cd backup
      put largefile.bin
      ls -la
      bye
      EOF

      **Execute batch:**
      sftp -b sftp_commands.txt user@host

      **Using echo and pipes:**

      Single command:
      echo "ls" | sftp user@host

      Multiple commands:
      echo -e "cd uploads\nget document.txt\nbye" | sftp user@host

      **Using heredoc:**
      sftp user@host << 'EOF'
      cd uploads
      get *.txt
      bye
      EOF

      **Progress indicator -v:**
      sftp -v user@host

      Shows detailed transfer progress.

      **Quiet mode -q:**
      sftp -q user@host

      Suppresses progress, shows errors only.

      **Using with SSH key:**
      sftp -i ~/.ssh/key user@host

      **Port specification:**
      sftp -P 2222 user@host

      (Note: Capital P for SFTP, unlike ssh's lowercase p)

      **Resume transfers (advantage over SCP):**

      SFTP supports resume:
      sftp> reget largefile.bin

      Continues partial download!

      **Create automation script:**
      cat > upload_files.sh << 'EOF'
      #!/bin/bash

      sftp -o StrictHostKeyChecking=no fileserver@localhost << 'SFTP_EOF'
      cd uploads
      put document.txt
      put config.conf
      ls -la
      bye
      SFTP_EOF

      echo "Upload complete!"
      EOF

      chmod +x upload_files.sh

      **Execute:**
      ./upload_files.sh

      **Batch file with error handling:**
      cat > safe_upload.txt << 'EOF'
      -mkdir uploads
      cd uploads
      put important_file.txt
      EOF

      Minus (-) before command: Continue on error

      **Practice:**

      Create batch file:
      cat > my_sftp_batch.txt << 'EOF'
      pwd
      ls
      cd uploads
      ls
      bye
      EOF

      Execute:
      sftp -b my_sftp_batch.txt -o StrictHostKeyChecking=no fileserver@localhost

      **Download automation:**
      cat > download_batch.txt << 'EOF'
      cd uploads
      get document.txt /tmp/downloaded_document.txt
      mget test*.txt
      bye
      EOF

      sftp -b download_batch.txt fileserver@localhost
    hint: "Use -b flag with batch file: sftp -b commands.txt user@host"
    validation:
      type: "command-output"
      command: "echo -e 'pwd\\nbye' > /tmp/sftp_batch.txt && sftp -b /tmp/sftp_batch.txt -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null fileserver@localhost 2>&1 | grep -i 'home\\|sftp'"
      matcher: "contains"
      expected: ""

  - id: "file-transfer-comparison"
    title: "Comparison: SCP vs SFTP vs rsync"
    description: |
      **Choosing the Right Tool:**

      **SCP - Simple, Fast Copy:**
      âœ“ Quick one-off transfers
      âœ“ Scripting (non-interactive)
      âœ“ Fast for small files
      âœ“ Simple syntax
      âœ— No resume
      âœ— No file management
      âœ— Inefficient for many small files

      **SFTP - Interactive File Management:**
      âœ“ Interactive browsing
      âœ“ Remote file management
      âœ“ Resume transfers
      âœ“ Batch mode
      âœ— Slower than SCP
      âœ— More complex for simple tasks

      **rsync - Synchronization (not always available):**
      âœ“ Sync only changed files
      âœ“ Very efficient
      âœ“ Progress indicators
      âœ“ Resume transfers
      âœ“ Compression
      âœ— More complex syntax
      âœ— Requires rsync on both sides

      **Use cases:**

      **Quick file copy:**
      scp file.txt user@host:/path/

      **Upload directory:**
      scp -r directory/ user@host:/path/

      **Interactive session:**
      sftp user@host

      **Sync large directory:**
      rsync -avz directory/ user@host:/path/

      **Backup automation:**
      rsync -avz --delete /data/ user@backup-server:/backups/data/

      **Progress for large file:**
      rsync -avP largefile user@host:/path/
      (or use SFTP with -v)

      **Resume interrupted transfer:**
      SFTP: reget file
      rsync: Just run again (auto-resumes)
      SCP: Start over (no resume)

      **Performance comparison:**

      Small file (1MB):
      SCP: ~0.1s
      SFTP: ~0.2s
      rsync: ~0.3s (overhead)

      Large file (1GB):
      SCP: Fast
      SFTP: Same speed, resumable
      rsync: Fast + resumable

      Many small files:
      SCP: Slow (many SSH connections)
      SFTP: Better
      rsync: Best (batching)

      Directory sync:
      SCP: Copies everything
      SFTP: Manual selection
      rsync: Only changes

      **Combination approaches:**

      Initial upload (SCP):
      scp -r site/ user@server:/var/www/

      Updates (rsync):
      rsync -avz --delete site/ user@server:/var/www/

      Quick fixes (SFTP):
      sftp user@server
      sftp> cd /var/www/site
      sftp> put index.html

      **Security:**
      All three use SSH - equally secure!

      **Practice different tools:**

      SCP upload:
      scp largefile.bin fileserver@localhost:/home/fileserver/uploads/

      SFTP upload with progress:
      echo "put largefile.bin" | sftp -v fileserver@localhost:/home/fileserver/uploads/

      If rsync available:
      rsync -avP largefile.bin fileserver@localhost:/home/fileserver/uploads/

      **Recommendation:**
      - Scripts/automation: SCP
      - Interactive work: SFTP
      - Large syncs: rsync (if available)
    hint: "SCP for quick copies, SFTP for interactive, rsync for sync"
    validation:
      type: "command-output"
      command: "echo 'SCP for scripts, SFTP for interactive, rsync for sync' | grep -i 'scp'"
      matcher: "contains"
      expected: "SCP"

  - id: "transfer-performance"
    title: "Optimizing File Transfer Performance"
    description: |
      **Speed Up Transfers:**

      **1. Compression (-C):**

      SCP with compression:
      scp -C largefile.txt user@host:/path/

      SFTP with compression:
      sftp -C user@host

      **Trade-off:**
      - Slow network + compressible data = Faster
      - Fast network + compressed data = Slower
      - Images/videos already compressed = No benefit

      **2. Cipher selection:**

      Faster cipher (less CPU, less secure):
      scp -c aes128-ctr file user@host:/path/

      Default cipher (balanced):
      scp -c aes256-ctr file user@host:/path/

      Fastest (least secure):
      scp -c arcfour file user@host:/path/

      **3. Disable encryption (testing only!):**

      NOT RECOMMENDED for production!
      scp -o Cipher=none file user@host:/path/

      Only for testing/benchmarking on trusted networks.

      **4. Connection reuse (ControlMaster):**

      ~/.ssh/config:
      ```
      Host *
          ControlMaster auto
          ControlPath ~/.ssh/sockets/%r@%h:%p
          ControlPersist 10m
      ```

      First connection: Establishes master
      Subsequent connections: Reuse master (instant!)

      **5. Parallel transfers:**

      Multiple SCP in parallel:
      scp file1 user@host:/path/ &
      scp file2 user@host:/path/ &
      scp file3 user@host:/path/ &
      wait

      Or use GNU parallel:
      parallel scp {} user@host:/path/ ::: file1 file2 file3

      **6. Archive before transfer:**

      For many small files:
      tar czf - directory/ | ssh user@host 'cat > archive.tar.gz'

      Then extract remotely:
      ssh user@host 'tar xzf archive.tar.gz'

      Much faster than:
      scp -r directory/ user@host:/path/

      **7. Adjust SSH buffers:**

      In ~/.ssh/config:
      ```
      Host fastserver
          HostName server.com
          Compression yes
          CompressionLevel 6
          TCPKeepAlive yes
      ```

      **Benchmark comparison:**

      Test transfer speed:
      time scp largefile user@host:/tmp/

      With compression:
      time scp -C largefile user@host:/tmp/

      Fast cipher:
      time scp -c aes128-ctr largefile user@host:/tmp/

      **Network diagnostics:**

      Check bandwidth:
      iperf3 -c server.com

      Check latency:
      ping server.com

      **Practice:**

      Transfer with compression:
      time scp -C largefile.bin fileserver@localhost:/home/fileserver/uploads/

      Transfer without compression:
      time scp largefile.bin fileserver@localhost:/home/fileserver/uploads/largefile2.bin

      Compare times!

      **Best practices:**
      â˜‘ Use compression for text/logs
      â˜‘ Skip compression for media files
      â˜‘ Use ControlMaster for multiple transfers
      â˜‘ Archive many small files before transfer
      â˜‘ Consider rsync for large syncs
      â˜‘ Test different methods for your use case
    hint: "Use -C for compression: scp -C file user@host:/path/"
    validation:
      type: "command-output"
      command: "scp -C -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null /home/learner/largefile.bin fileserver@localhost:/home/fileserver/uploads/compressed.bin 2>/dev/null && ssh -o StrictHostKeyChecking=no fileserver@localhost 'ls /home/fileserver/uploads/compressed.bin' 2>/dev/null"
      matcher: "contains"
      expected: "compressed.bin"

completion:
  message: |
    ðŸŽ‰ SCP AND SFTP MASTERED! ðŸŽ‰

    You've mastered secure file transfer with SCP and SFTP!

    **What You've Learned:**

    âœ“ SCP for quick file copies
    âœ“ Recursive directory transfers
    âœ“ Wildcards and pattern matching
    âœ“ SFTP interactive sessions
    âœ“ SFTP batch mode and automation
    âœ“ Comparing transfer tools
    âœ“ Performance optimization

    **Quick Reference:**

    **SCP Commands:**

    Upload file:
    scp file.txt user@host:/path/

    Download file:
    scp user@host:/path/file.txt ./

    Upload directory:
    scp -r directory/ user@host:/path/

    Download directory:
    scp -r user@host:/path/directory/ ./

    With options:
    scp -rp directory/ user@host:/path/     # Preserve attributes
    scp -C file user@host:/path/            # Compress
    scp -v file user@host:/path/            # Verbose
    scp -P 2222 file user@host:/path/       # Custom port
    scp -i key file user@host:/path/        # Specific key

    Multiple files:
    scp *.txt user@host:/path/
    scp file1 file2 file3 user@host:/path/

    **SFTP Commands:**

    Interactive session:
    sftp user@host

    Within SFTP:
    ls, cd, pwd          # Navigate remote
    lls, lcd, lpwd       # Navigate local
    get file             # Download
    put file             # Upload
    mget *.txt           # Download multiple
    mput *.txt           # Upload multiple
    mkdir, rm, rmdir     # File management
    bye, exit, quit      # Exit

    Batch mode:
    sftp -b commands.txt user@host

    Single command:
    echo "get file.txt" | sftp user@host

    **Common Options:**

    SCP:
    -r    Recursive
    -p    Preserve times/modes
    -v    Verbose
    -C    Compression
    -P    Port (capital P!)
    -i    Identity file
    -q    Quiet

    SFTP:
    -b    Batch file
    -P    Port (capital P!)
    -i    Identity file
    -v    Verbose
    -C    Compression

    **Tool Selection:**

    Quick copy:
    scp file.txt user@host:/path/

    Interactive work:
    sftp user@host

    Many small files:
    tar czf - dir/ | ssh user@host 'tar xzf - -C /path/'

    Sync directories:
    rsync -avz dir/ user@host:/path/

    **Performance Tips:**

    Compress text files:
    scp -C logfile.txt user@host:/path/

    Parallel transfers:
    scp file1 user@host:/path/ &
    scp file2 user@host:/path/ &
    wait

    Archive many files:
    tar czf - dir/ | ssh user@host 'cat > archive.tar.gz'

    Connection reuse (in ~/.ssh/config):
    ControlMaster auto
    ControlPath ~/.ssh/sockets/%r@%h:%p
    ControlPersist 10m

    **Best Practices:**

    â˜‘ Use SSH keys (avoid passwords)
    â˜‘ Test with -v first (verbose)
    â˜‘ Use -p to preserve attributes
    â˜‘ Compress text/logs, not media
    â˜‘ Archive before transferring many small files
    â˜‘ Use wildcards carefully (quote remote)
    â˜‘ Batch SFTP commands for automation
    â˜‘ Use rsync for large directory syncs

    **Common Patterns:**

    Backup to remote:
    scp -rp /important/data/ user@backup:/backups/

    Download logs:
    scp 'user@server:/var/log/app*.log' ./logs/

    Upload website:
    scp -r website/ user@server:/var/www/

    Interactive file management:
    sftp user@server
    cd /var/www
    put index.html
    get config.php

    Automated backup:
    sftp -b backup_commands.txt user@server

    **Security Notes:**

    âœ“ All transfers encrypted (uses SSH)
    âœ“ Same authentication as SSH
    âœ“ Host key verification
    âœ“ Works with SSH keys
    âœ“ Firewall-friendly (uses SSH port)

    **Troubleshooting:**

    Permission denied:
    - Check SSH key setup
    - Verify remote path permissions
    - Ensure remote directory exists

    Connection refused:
    - Check SSH service running
    - Verify hostname/IP
    - Check firewall rules

    Transfer slow:
    - Try compression (-C)
    - Check network bandwidth
    - Consider rsync instead
    - Use faster cipher

    You now have professional file transfer skills!

    EXCELLENT WORK!
  xp: 300
  unlocks:
    - "linux/week14/ssh-advanced"
    - "linux/week14/practice-remote-admin"
