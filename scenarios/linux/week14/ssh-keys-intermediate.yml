mission:
  id: "linux/week14/ssh-keys-intermediate"
  title: "SSH Key-Based Authentication"
  difficulty: intermediate
  description: "Master SSH key generation, management, and passwordless authentication"
  estimated_time: 40
  tags:
    - linux
    - ssh
    - ssh-keys
    - authentication
    - security
    - intermediate
    - week14
    - cst8207

environment:
  image: "ubuntu:22.04"
  workdir: "/home/learner"
  setup:
    - "apt-get update -qq && apt-get install -y -qq openssh-client openssh-server"
    - "service ssh start"
    - "useradd -m -s /bin/bash testuser"
    - "echo 'testuser:password123' | chpasswd"
    - "mkdir -p /home/testuser/.ssh"
    - "chmod 700 /home/testuser/.ssh"
    - "chown testuser:testuser /home/testuser/.ssh"
    - "mkdir -p /home/learner/.ssh"
    - "chmod 700 /home/learner/.ssh"

steps:
  - id: "understand-keys"
    title: "SSH Key Authentication Concepts"
    description: |
      **Why SSH Keys?**

      **Password Authentication:**
      âœ— Can be guessed (brute force)
      âœ— Needs to be typed each time
      âœ— Can be intercepted (keyloggers)
      âœ— Hard to manage many servers

      **SSH Key Authentication:**
      âœ“ Extremely secure (4096-bit encryption)
      âœ“ Passwordless login
      âœ“ Cannot be brute-forced
      âœ“ One key for many servers
      âœ“ Can be revoked easily

      **How SSH Keys Work:**

      1. Generate key pair:
         - Private key (secret, stays on your computer)
         - Public key (shared, copied to servers)

      2. Setup:
         - Copy public key to server's ~/.ssh/authorized_keys
         - Keep private key secure on client

      3. Authentication:
         - Client proves it has private key
         - Server verifies with public key
         - No password sent over network!

      **Analogy:**
      - Public key = Lock (put on any door)
      - Private key = Key (only you have it)
      - Anyone can install your lock, but only your key opens it

      **Key Formats:**

      Private key: ~/.ssh/id_rsa (or id_ed25519)
      Public key: ~/.ssh/id_rsa.pub

      **Security:**
      - Private key NEVER leaves your computer
      - Public key can be freely shared
      - Private key can be encrypted with passphrase (extra security)

      **Advantages in practice:**
      - Automated scripts (no password prompt)
      - Easier for system administrators
      - Disabled password auth = much more secure
      - Easy to add/remove access (add/remove public key)

      **View existing keys (if any):**
      ls -la ~/.ssh/id_*

      If empty, no keys exist yet - we'll create them next!
    hint: "Check for existing keys with: ls ~/.ssh/id_*"
    validation:
      type: "command-output"
      command: "ls -la /home/learner/.ssh/ 2>/dev/null | wc -l"
      matcher: "regex"
      expected: "[0-9]+"

  - id: "generate-key-rsa"
    title: "Generate RSA SSH Key Pair"
    description: |
      **Generate SSH Keys with ssh-keygen:**

      ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

      **Options explained:**
      -t rsa       Type: RSA algorithm
      -b 4096      Bits: 4096-bit key (very secure)
      -C "comment" Comment: Usually your email

      **Interactive prompts:**

      1. **Where to save:**
         Enter file in which to save the key (/home/user/.ssh/id_rsa):
         Press Enter for default location

      2. **Passphrase:**
         Enter passphrase (empty for no passphrase):
         Optional: Extra protection for private key
         Leave empty for passwordless automation

      3. **Confirm passphrase:**
         Enter same passphrase again:

      **Output:**
      - Private key: ~/.ssh/id_rsa
      - Public key: ~/.ssh/id_rsa.pub
      - Fingerprint shown

      **Example session:**
      ```
      $ ssh-keygen -t rsa -b 4096 -C "user@example.com"
      Generating public/private rsa key pair.
      Enter file in which to save the key (/home/user/.ssh/id_rsa):
      Enter passphrase (empty for no passphrase):
      Enter same passphrase again:
      Your identification has been saved in /home/user/.ssh/id_rsa
      Your public key has been saved in /home/user/.ssh/id_rsa.pub
      The key fingerprint is:
      SHA256:AbCdEf123456... user@example.com
      ```

      **Important:**
      - Default name: id_rsa / id_rsa.pub
      - Can have multiple keys (different names)
      - For automation: Don't use passphrase
      - For personal use: Use passphrase

      **Generate your key:**
      ssh-keygen -t rsa -b 4096 -C "learner@termgame" -N "" -f ~/.ssh/id_rsa

      -N "" = No passphrase
      -f ~/.ssh/id_rsa = Specify file (non-interactive)

      **Verify creation:**
      ls -la ~/.ssh/id_rsa*

      Should see:
      - id_rsa (private key, 600 permissions)
      - id_rsa.pub (public key, 644 permissions)

      **View public key:**
      cat ~/.ssh/id_rsa.pub

      Format: ssh-rsa AAAAB3NzaC... learner@termgame
    hint: "Use ssh-keygen -t rsa -b 4096 to generate key pair"
    validation:
      type: "file-exists"
      path: "/home/learner/.ssh/id_rsa"

  - id: "generate-key-ed25519"
    title: "Generate Ed25519 SSH Key (Modern)"
    description: |
      **Ed25519: Modern SSH Key Type**

      Ed25519 is newer and better than RSA:
      âœ“ Faster
      âœ“ More secure (same security with smaller key)
      âœ“ Smaller key size (256 bits)
      âœ“ Recommended by security experts

      **Generate Ed25519 key:**
      ssh-keygen -t ed25519 -C "your_email@example.com"

      **Comparison:**

      | Feature | RSA 4096 | Ed25519 |
      |---------|----------|---------|
      | Key size | 4096 bits | 256 bits |
      | Speed | Slower | Faster |
      | Security | Strong | Stronger |
      | Compatibility | Universal | Modern systems |

      **When to use which:**

      Use RSA:
      - Old servers (no Ed25519 support)
      - Maximum compatibility

      Use Ed25519:
      - Modern servers (2014+)
      - Best security and performance
      - Personal preference

      **File names:**
      RSA: ~/.ssh/id_rsa, ~/.ssh/id_rsa.pub
      Ed25519: ~/.ssh/id_ed25519, ~/.ssh/id_ed25519.pub

      **Generate Ed25519 key:**
      ssh-keygen -t ed25519 -C "learner@termgame" -N "" -f ~/.ssh/id_ed25519

      **View keys:**
      ls -la ~/.ssh/id_*

      You now have both types:
      - id_rsa / id_rsa.pub (RSA)
      - id_ed25519 / id_ed25519.pub (Ed25519)

      **Default key selection:**

      SSH tries keys in this order:
      1. id_ed25519
      2. id_rsa
      3. id_ecdsa
      4. id_dsa

      Or specify: ssh -i ~/.ssh/specific_key user@host

      **View Ed25519 public key:**
      cat ~/.ssh/id_ed25519.pub

      Format: ssh-ed25519 AAAAC3... learner@termgame

      Notice: Much shorter than RSA key!

      **Best practice:**
      Generate both, use Ed25519 when possible, fall back to RSA for old systems.
    hint: "Use ssh-keygen -t ed25519 for modern Ed25519 keys"
    validation:
      type: "file-exists"
      path: "/home/learner/.ssh/id_ed25519"

  - id: "copy-public-key"
    title: "Copy Public Key to Server"
    description: |
      **ssh-copy-id: Easy Key Distribution**

      Copy your public key to a server for passwordless login.

      **Command:**
      ssh-copy-id user@hostname

      **What it does:**
      1. Connects to server (asks for password one last time)
      2. Copies your public key to ~/.ssh/authorized_keys
      3. Sets correct permissions automatically
      4. Future connections: passwordless!

      **Example:**
      ```
      $ ssh-copy-id john@server.com
      /usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s)
      john@server.com's password: [enter password]
      Number of key(s) added: 1

      Now try logging into the machine with:
         ssh john@server.com
      and check to make sure that only the key(s) you wanted were added.
      ```

      **Specify which key:**
      ssh-copy-id -i ~/.ssh/id_ed25519.pub user@host

      **What happens on server:**

      Your public key is appended to:
      ~/.ssh/authorized_keys

      Format (one key per line):
      ssh-rsa AAAAB3NzaC... user@client1
      ssh-ed25519 AAAAC3... user@client2

      **Manual method (if ssh-copy-id not available):**

      cat ~/.ssh/id_rsa.pub | ssh user@host 'mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'

      **Practice - Copy key to testuser:**

      First, let's set up testuser's authorized_keys:

      # Show current public key
      cat ~/.ssh/id_rsa.pub

      # Manually add to testuser's authorized_keys
      sudo mkdir -p /home/testuser/.ssh
      sudo cat ~/.ssh/id_rsa.pub | sudo tee -a /home/testuser/.ssh/authorized_keys
      sudo chmod 600 /home/testuser/.ssh/authorized_keys
      sudo chown testuser:testuser /home/testuser/.ssh/authorized_keys

      **Verify setup:**
      sudo ls -la /home/testuser/.ssh/
      sudo cat /home/testuser/.ssh/authorized_keys

      **Test passwordless login:**
      ssh -o StrictHostKeyChecking=no testuser@localhost

      Should connect WITHOUT password!

      **Try the manual copy process:**
      View your public key, then set up authorized_keys as shown above.
    hint: "Use ssh-copy-id or manually append public key to authorized_keys"
    validation:
      type: "command-output"
      command: "test -f /home/testuser/.ssh/authorized_keys && cat /home/testuser/.ssh/authorized_keys | wc -l"
      matcher: "regex"
      expected: "[1-9]"

  - id: "test-key-auth"
    title: "Test Key-Based Authentication"
    description: |
      **Test Passwordless SSH:**

      After copying your public key, test the connection:

      ssh user@hostname

      Should connect WITHOUT asking for password!

      **What happens during key authentication:**

      1. Client: "I want to connect as user"
      2. Server: "Prove you have the private key for this public key"
      3. Client: (uses private key to prove identity, sends proof)
      4. Server: "Proof valid! Welcome!"
      5. Connection established

      All cryptographic - no password sent!

      **Troubleshooting: Still asks for password?**

      **Check 1: Is your key on the server?**
      ssh user@host 'cat ~/.ssh/authorized_keys'

      Should contain your public key.

      **Check 2: Permissions correct?**
      ssh user@host 'ls -la ~/.ssh/authorized_keys'

      Should be: -rw------- (600)

      **Check 3: Which key is being used?**
      ssh -v user@host

      Look for: "Offering public key: /home/user/.ssh/id_rsa"

      **Check 4: Server allows key authentication?**
      sudo cat /etc/ssh/sshd_config | grep PubkeyAuthentication

      Should be: PubkeyAuthentication yes

      **Check 5: Local key permissions?**
      ls -la ~/.ssh/id_rsa

      Should be: -rw------- (600)

      **Verbose mode for debugging:**
      ssh -vvv user@host

      Shows:
      - Which keys are tried
      - Authentication methods offered
      - Success/failure reasons

      **Force specific key:**
      ssh -i ~/.ssh/id_ed25519 user@host

      **Test your setup:**
      ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null testuser@localhost 'whoami'

      Should output: testuser (without password prompt)

      **Multiple connections:**
      for i in {1..3}; do
        ssh testuser@localhost 'echo "Connection $i: $(date)"'
      done

      All three should connect instantly, no password!

      **Practice:**
      Test the connection several times to verify it's truly passwordless.
    hint: "Test with: ssh user@localhost (should not ask for password)"
    validation:
      type: "command-output"
      command: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes testuser@localhost 'echo SUCCESS' 2>/dev/null || echo 'key auth not working'"
      matcher: "contains"
      expected: "SUCCESS"

  - id: "multiple-keys"
    title: "Managing Multiple SSH Keys"
    description: |
      **Multiple Keys for Different Services:**

      Common scenario:
      - Personal GitHub: personal_key
      - Work GitHub: work_key
      - AWS servers: aws_key
      - Client servers: client_key

      **Generate multiple keys:**

      Personal:
      ssh-keygen -t ed25519 -C "personal@email.com" -f ~/.ssh/id_personal

      Work:
      ssh-keygen -t ed25519 -C "work@company.com" -f ~/.ssh/id_work

      AWS:
      ssh-keygen -t rsa -b 4096 -C "aws-admin" -f ~/.ssh/aws_key

      **~/.ssh/config for multiple keys:**

      ```
      # Personal GitHub
      Host github.com-personal
          HostName github.com
          User git
          IdentityFile ~/.ssh/id_personal
          IdentitiesOnly yes

      # Work GitHub
      Host github.com-work
          HostName github.com
          User git
          IdentityFile ~/.ssh/id_work
          IdentitiesOnly yes

      # AWS Production
      Host aws-prod-*
          User ubuntu
          IdentityFile ~/.ssh/aws_key
          StrictHostKeyChecking no

      # Client servers
      Host client.example.com
          User admin
          IdentityFile ~/.ssh/client_key
          Port 2222
      ```

      **Usage:**
      git clone git@github.com-personal:user/repo.git
      git clone git@github.com-work:company/repo.git
      ssh aws-prod-web-01
      ssh client.example.com

      **IdentitiesOnly:**
      Prevents SSH from trying ALL keys (which can cause login failures
      if server limits authentication attempts).

      **List all keys:**
      ls -la ~/.ssh/id_* ~/.ssh/*_key*

      **View key fingerprints:**
      ssh-keygen -l -f ~/.ssh/id_rsa
      ssh-keygen -l -f ~/.ssh/id_ed25519

      **SSH Agent (covered later) helps:**
      - Load multiple keys
      - Don't need to specify -i each time
      - Unlock passphrases once

      **Create multiple keys for practice:**
      ssh-keygen -t ed25519 -C "github" -N "" -f ~/.ssh/github_key
      ssh-keygen -t ed25519 -C "server" -N "" -f ~/.ssh/server_key

      **Configure them:**
      cat >> ~/.ssh/config << 'EOF'

      Host github
          HostName github.com
          User git
          IdentityFile ~/.ssh/github_key

      Host myserver
          HostName localhost
          User testuser
          IdentityFile ~/.ssh/server_key
      EOF

      **Test:**
      ssh -T github
      (will fail - not real GitHub, but shows key would be used)
    hint: "Create multiple keys with different -f filenames"
    validation:
      type: "command-output"
      command: "ls /home/learner/.ssh/id_* 2>/dev/null | wc -l"
      matcher: "regex"
      expected: "[2-9]|[1-9][0-9]"

  - id: "ssh-agent"
    title: "SSH Agent for Key Management"
    description: |
      **SSH Agent: Password Manager for SSH Keys**

      Problem: Keys with passphrases require typing passphrase each time.

      Solution: SSH Agent
      - Runs in background
      - Stores unlocked keys in memory
      - Type passphrase once per session
      - All SSH commands use agent automatically

      **Start SSH agent:**
      eval "$(ssh-agent -s)"

      Output: Agent pid 12345

      **Add key to agent:**
      ssh-add ~/.ssh/id_rsa

      If passphrase protected, prompts once:
      Enter passphrase for /home/user/.ssh/id_rsa:

      **List loaded keys:**
      ssh-add -l

      Output:
      4096 SHA256:abc123... user@host (RSA)
      256 SHA256:def456... user@host (ED25519)

      **Add specific key:**
      ssh-add ~/.ssh/specific_key

      **Add with lifetime:**
      ssh-add -t 3600 ~/.ssh/id_rsa

      (Key removed after 1 hour)

      **Remove key:**
      ssh-add -d ~/.ssh/id_rsa

      **Remove all keys:**
      ssh-add -D

      **How agent works:**

      1. ssh-agent starts (background process)
      2. ssh-add loads keys (prompts for passphrases)
      3. SSH commands automatically use agent
      4. No more passphrase prompts!

      **Agent forwarding (-A):**

      ssh -A user@jumphost

      Allows jumphost to use YOUR keys for further connections:
      local â†’ jumphost â†’ destination

      **Warning:** Only forward to trusted servers!

      **Persistent agent:**

      Add to ~/.bashrc or ~/.profile:
      ```bash
      if [ -z "$SSH_AUTH_SOCK" ]; then
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-add ~/.ssh/id_ed25519
      fi
      ```

      **Alternative: keychain**

      Better than manual ssh-agent management:
      ```bash
      eval "$(keychain --eval --quiet id_rsa id_ed25519)"
      ```

      **Practice:**

      Start agent:
      eval "$(ssh-agent -s)"

      Add keys:
      ssh-add ~/.ssh/id_rsa
      ssh-add ~/.ssh/id_ed25519

      List loaded keys:
      ssh-add -l

      Test connection (uses agent automatically):
      ssh testuser@localhost 'echo "Agent working!"'

      **Check agent status:**
      echo $SSH_AUTH_SOCK
      echo $SSH_AGENT_PID

      Should show socket path and PID.
    hint: "Start agent with eval $(ssh-agent -s), add keys with ssh-add"
    validation:
      type: "command-output"
      command: "eval $(ssh-agent -s) > /dev/null 2>&1 && echo $SSH_AGENT_PID"
      matcher: "regex"
      expected: "[0-9]+"

  - id: "key-security"
    title: "SSH Key Security Best Practices"
    description: |
      **Securing Your SSH Keys:**

      **1. Use passphrases:**

      Protect private keys with passphrases:
      ssh-keygen -t ed25519 -C "email" -N "strongpassphrase"

      Even if key file is stolen, attacker needs passphrase.

      **Change passphrase:**
      ssh-keygen -p -f ~/.ssh/id_rsa

      **2. Correct permissions (critical!):**

      ~/.ssh/                700 (drwx------)
      ~/.ssh/config          600 (-rw-------)
      ~/.ssh/id_rsa          600 (-rw-------)
      ~/.ssh/id_rsa.pub      644 (-rw-r--r--)
      ~/.ssh/authorized_keys 600 (-rw-------)
      ~/.ssh/known_hosts     644 (-rw-r--r--)

      **Fix all permissions:**
      chmod 700 ~/.ssh
      chmod 600 ~/.ssh/config
      chmod 600 ~/.ssh/id_*
      chmod 644 ~/.ssh/*.pub
      chmod 600 ~/.ssh/authorized_keys

      **3. Never share private keys:**

      âœ— Don't email private keys
      âœ— Don't commit to Git
      âœ— Don't store in cloud (Dropbox, Google Drive)
      âœ“ Keep on your computer only
      âœ“ Share public keys freely

      **4. Separate keys for different purposes:**

      Personal:    ~/.ssh/id_personal
      Work:        ~/.ssh/id_work
      High-value:  ~/.ssh/id_prod (with passphrase!)

      **5. Regular key rotation:**

      Generate new keys periodically:
      - Personal: Yearly
      - Work: When leaving company
      - Production: Every 6-12 months

      **6. Audit authorized_keys:**

      Regularly check servers:
      cat ~/.ssh/authorized_keys

      Remove old/unknown keys:
      sed -i '/old-key-comment/d' ~/.ssh/authorized_keys

      **7. Use SSH agent correctly:**

      âœ“ Lock screen when away
      âœ“ Use agent timeouts (-t)
      âœ— Don't forward to untrusted servers (-A)

      **8. Backup keys securely:**

      Encrypted backup:
      tar czf ssh-keys.tar.gz ~/.ssh/
      gpg -c ssh-keys.tar.gz
      rm ssh-keys.tar.gz

      Store encrypted file safely.

      **9. Restrict key usage (advanced):**

      In authorized_keys, prefix key with restrictions:
      ```
      command="/usr/bin/rsync-only",no-port-forwarding ssh-rsa AAAA...
      ```

      **10. Monitor SSH logs:**

      Watch for unauthorized access:
      sudo tail -f /var/log/auth.log | grep sshd

      **Security checklist:**
      â˜ All keys have passphrases
      â˜ Permissions correct (700/600)
      â˜ Private keys never shared
      â˜ Separate keys per purpose
      â˜ Regular key rotation schedule
      â˜ Authorized_keys audited
      â˜ SSH agent configured with timeouts
      â˜ Keys backed up (encrypted)
      â˜ Logs monitored

      **Verify your security:**
      ls -la ~/.ssh/
      Check all permissions!
    hint: "Always use 700 for .ssh dir, 600 for private keys"
    validation:
      type: "command-output"
      command: "ls -la /home/learner/.ssh/ | head -1"
      matcher: "contains"
      expected: "drwx"

completion:
  message: |
    ðŸŽ‰ SSH KEY AUTHENTICATION MASTERED! ðŸŽ‰

    You've mastered SSH key-based authentication!

    **What You've Learned:**

    âœ“ SSH key authentication concepts
    âœ“ Generating RSA and Ed25519 keys
    âœ“ Public vs private keys
    âœ“ Copying public keys to servers
    âœ“ Testing passwordless authentication
    âœ“ Managing multiple SSH keys
    âœ“ SSH Agent for key management
    âœ“ Security best practices

    **Quick Reference:**

    **Generate Keys:**
    ssh-keygen -t rsa -b 4096 -C "email"
    ssh-keygen -t ed25519 -C "email"
    ssh-keygen -t ed25519 -C "email" -f ~/.ssh/custom_name

    **Copy to Server:**
    ssh-copy-id user@hostname
    ssh-copy-id -i ~/.ssh/specific_key.pub user@host

    **Manual Copy:**
    cat ~/.ssh/id_rsa.pub | ssh user@host 'cat >> ~/.ssh/authorized_keys'

    **SSH Agent:**
    eval "$(ssh-agent -s)"    # Start agent
    ssh-add ~/.ssh/id_rsa     # Add key
    ssh-add -l                # List keys
    ssh-add -D                # Remove all keys
    ssh-add -t 3600 key       # Add with 1hr timeout

    **Multiple Keys in ~/.ssh/config:**
    ```
    Host github-personal
        HostName github.com
        User git
        IdentityFile ~/.ssh/id_personal

    Host work-server
        HostName server.company.com
        User admin
        IdentityFile ~/.ssh/id_work
        Port 2222
    ```

    **File Permissions:**
    ~/.ssh/                  700
    ~/.ssh/config            600
    ~/.ssh/id_rsa            600
    ~/.ssh/id_rsa.pub        644
    ~/.ssh/authorized_keys   600

    **Key Types Comparison:**
    RSA 4096:   Universal compatibility, slower
    Ed25519:    Modern, faster, smaller, recommended

    **Security Best Practices:**

    â˜‘ Use passphrases on private keys
    â˜‘ Never share private keys
    â˜‘ Use SSH agent for convenience
    â˜‘ Separate keys for different purposes
    â˜‘ Rotate keys regularly
    â˜‘ Audit authorized_keys periodically
    â˜‘ Correct file permissions always
    â˜‘ Backup keys securely (encrypted)
    â˜‘ Use IdentitiesOnly in config
    â˜‘ Monitor SSH logs

    **Troubleshooting:**

    Still prompts for password?
    - Check authorized_keys contains your public key
    - Verify authorized_keys is 600 permissions
    - Check private key is 600 permissions
    - Use ssh -v to debug
    - Verify PubkeyAuthentication yes on server

    Permission denied?
    - Check username correct
    - Verify key copied to right user
    - Check ~/.ssh directory is 700
    - Use ssh -vvv for detailed debugging

    **Common Workflows:**

    **Setup new server:**
    1. ssh-keygen -t ed25519 -C "server-name"
    2. ssh-copy-id user@new-server
    3. ssh user@new-server (test)
    4. Disable password auth on server

    **Setup new client:**
    1. ssh-keygen -t ed25519 -C "my-email"
    2. cat ~/.ssh/id_ed25519.pub
    3. Add to servers' authorized_keys
    4. Add to GitHub/GitLab/Bitbucket

    **Daily use:**
    1. eval "$(ssh-agent -s)"
    2. ssh-add (passphrases once)
    3. ssh anywhere (no more passwords!)

    **Advantages Over Passwords:**
    âœ“ More secure (4096-bit vs 8-char password)
    âœ“ Passwordless (convenience)
    âœ“ One key, many servers
    âœ“ Can't be brute-forced
    âœ“ Easy to revoke (remove from authorized_keys)
    âœ“ Works with automation/scripts

    You now have professional-grade SSH authentication skills!

    EXCELLENT WORK!
  xp: 300
  unlocks:
    - "linux/week14/ssh-advanced"
    - "linux/week14/scp-sftp-intermediate"
