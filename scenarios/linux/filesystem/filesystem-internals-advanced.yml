mission:
  id: linux/filesystem/filesystem-internals-advanced
  title: 'Deep Dive: Filesystem Internals, Inodes, and Links'
  difficulty: advanced
  description: Understand how the Linux filesystem really works - inodes, hard links,
    symbolic links, and disk structures
  estimated_time: 70
  tags:
  - linux
  - filesystem
  - inodes
  - links
  - advanced
environment:
  image: ubuntu:22.04
  workdir: /home/learner
  setup:
  - mkdir -p /home/learner/data /home/learner/backup /home/learner/shared
  - echo 'Original content in file1' > /home/learner/data/file1.txt
  - echo 'Important data' > /home/learner/data/important.txt
  - mkdir -p /home/learner/projects/web /home/learner/projects/api
  - echo 'Web project files' > /home/learner/projects/web/index.html
  - echo 'API code' > /home/learner/projects/api/server.js
steps:
- id: understand-inodes
  title: Understand Inodes - The Filesystem's Index
  description: '**What is an Inode?**


    An inode (index node) is a data structure that stores metadata about a file:

    - File size

    - Ownership (user/group)

    - Permissions

    - Timestamps (created, modified, accessed)

    - Number of hard links

    - Location of data blocks on disk


    **Important:** The filename is NOT stored in the inode!

    Filenames are stored in directory entries that point to inodes.


    **View Inode Information:**


    Use ls -i to see inode numbers:

    ls -i data/file1.txt


    Use stat for detailed inode information:

    stat data/file1.txt


    The stat command shows:

    - Inode number

    - Number of links

    - Size

    - Block allocation

    - All timestamps

    - Permissions in octal


    Try both commands and observe the output.

    '
  hint: 'Type: ls -i data/file1.txt and stat data/file1.txt'
  validation:
    type: command-output
    command: stat /home/learner/data/file1.txt | grep Inode
    matcher: contains
    expected: Inode
- id: inode-vs-filename
  title: 'Separate Concept: Inode vs Filename'
  description: '**Key Concept:** Files are accessed through inodes, not names.


    The filesystem works like this:

    1. You ask for "file1.txt"

    2. Directory finds inode number for "file1.txt"

    3. System reads inode to get file metadata

    4. System reads data blocks pointed to by inode


    **Demonstration:**


    Get the inode number:

    ls -i data/file1.txt


    Find all filenames pointing to that inode:

    find ~ -inum INODE_NUMBER


    (Replace INODE_NUMBER with the actual number)


    This reveals that multiple filenames can point to the same inode

    (same file, different names). This is called HARD LINKING.


    Try it:

    inode=$(ls -i data/file1.txt | awk ''{print $1}'')

    echo "Inode number: $inode"

    find ~ -inum $inode

    '
  hint: 'Get inode with: ls -i file | awk ''{print $1}'', then use find -inum'
  validation:
    type: command-output
    command: ls -i /home/learner/data/file1.txt | awk '{print $1}' | grep -E '^[0-9]+$'
    matcher: contains
    expected: ''
- id: create-hard-link
  title: Create Hard Links - Multiple Names, Same File
  description: '**Hard Links Explained:**


    A hard link creates another name (directory entry) pointing to the

    same inode. Both names are equals - there''s no "original."


    **Create a Hard Link:**

    ln data/file1.txt data/file1_link.txt


    (Note: No -s flag means hard link)


    **What Just Happened:**

    - New directory entry "file1_link.txt" created

    - Points to SAME inode as "file1.txt"

    - Link count in inode increased by 1

    - Both names access the SAME data blocks


    **Verify:**

    ls -li data/file1*.txt


    You should see:

    - Same inode number for both files

    - Same file size

    - Link count = 2


    stat data/file1.txt | grep Links

    stat data/file1_link.txt | grep Links


    Both show "Links: 2"


    **Test the link:**

    echo "Modified via hard link" >> data/file1_link.txt

    cat data/file1.txt


    The change appears in both because they''re the same file!

    '
  hint: 'Type: ln data/file1.txt data/file1_link.txt then ls -li data/'
  validation:
    type: command-output
    command: ln /home/learner/data/file1.txt /tmp/hardlink && ls -i /home/learner/data/file1.txt
      /tmp/hardlink | awk '{print $1}' | sort -u | wc -l
    matcher: contains
    expected: '1'
- id: hard-link-properties
  title: Understand Hard Link Properties and Limitations
  description: "**Hard Link Properties:**\n\n1. **Same inode number** - Both names\
    \ point to same inode\n2. **Share all attributes** - Permissions, ownership, size\n\
    3. **Changes visible everywhere** - Edit one, see in all\n4. **Independent deletion**\
    \ - Delete one name, others remain\n5. **Inode deleted only when link count =\
    \ 0**\n\n**Hard Link Limitations:**\n\n❌ Cannot span filesystems/partitions\n\
    \   (Different partitions have different inode spaces)\n\n❌ Cannot link to directories\n\
    \   (Would create circular references)\n\n❌ Only for files on same partition\n\
    \n**Experiment:**\n\nCreate multiple hard links:\nln data/file1.txt backup/file1_backup1.txt\n\
    ln data/file1.txt backup/file1_backup2.txt\n\nCheck link count:\nstat data/file1.txt\
    \ | grep Links\n\nShould show \"Links: 4\" (original + 3 links)\n\nDelete the\
    \ original:\nrm data/file1.txt\n\nThe file still exists! Check:\ncat backup/file1_backup1.txt\n\
    \nThe inode and data remain because link count > 0.\nData is only deleted when\
    \ ALL hard links are removed.\n"
  hint: Create multiple hard links with ln, check link count with stat
  validation:
    type: command-output
    command: 'touch /tmp/test_hard && ln /tmp/test_hard /tmp/test_hard_link && \

      stat /tmp/test_hard | grep -o ''Links: [0-9]*''

      '
    matcher: contains
    expected: 'Links: 2'
- id: symbolic-links-intro
  title: Symbolic Links - Pointers to Files
  description: '**Symbolic Links (Symlinks) Explained:**


    A symbolic link is a SPECIAL FILE that contains a path to another file.

    It''s like a shortcut or reference.


    **Key Differences from Hard Links:**

    - Has its own inode number

    - Contains the path to target file (as text)

    - Can link to directories

    - Can span filesystems

    - Can point to non-existent files (broken link)

    - Is a separate file type (shown as ''l'' in ls -l)


    **Create a Symbolic Link:**

    ln -s data/important.txt data/important_symlink.txt


    The -s flag means "symbolic"


    **Examine the Link:**

    ls -l data/important_symlink.txt


    Output shows:

    lrwxrwxrwx ... important_symlink.txt -> data/important.txt


    - ''l'' = link type

    - ''-> data/important.txt'' = target path


    Compare inode numbers:

    ls -i data/important.txt data/important_symlink.txt


    Different inode numbers! They''re separate files.


    **Read through symlink:**

    cat data/important_symlink.txt


    The kernel automatically follows the link to the target file.

    '
  hint: 'Type: ln -s data/important.txt symlink.txt then ls -l symlink.txt'
  validation:
    type: command-output
    command: ln -s /home/learner/data/file1.txt /tmp/symlink && ls -l /tmp/symlink
      | grep '->'
    matcher: contains
    expected: ->
- id: symlink-vs-hardlink
  title: Compare Symbolic Links and Hard Links
  description: "**Side-by-Side Comparison:**\n\nCreate both types of links to the\
    \ same file:\n\necho \"Test content\" > test_original.txt\n\n# Hard link\nln test_original.txt\
    \ test_hard.txt\n\n# Symbolic link\nln -s test_original.txt test_sym.txt\n\n**Compare\
    \ them:**\nls -li test_*\n\nObservations:\n- test_original and test_hard: Same\
    \ inode, same size\n- test_sym: Different inode, small size (path length)\n\n\
    **Test behavior:**\n\n1. Modify original:\n   echo \"Added line\" >> test_original.txt\n\
    \   cat test_hard.txt   # Shows added line\n   cat test_sym.txt    # Shows added\
    \ line\n\n2. Delete original:\n   rm test_original.txt\n   cat test_hard.txt \
    \  # Still works! Data still exists\n   cat test_sym.txt    # BROKEN! \"No such\
    \ file\"\n\nThis demonstrates the key difference:\n- Hard link: Direct connection\
    \ to data (via shared inode)\n- Symlink: Path pointer (breaks if target removed)\n\
    \n**When to use each:**\n\nHard links:\n- Backup without duplicating data\n- Multiple\
    \ names for same file\n- Prevent accidental deletion\n- Must be on same filesystem\n\
    \nSymbolic links:\n- Link to directories\n- Link across filesystems\n- Point to\
    \ relative or absolute paths\n- Clear indication it's a link\n- Can be updated\
    \ by changing target\n"
  hint: Create both types, compare with ls -li, test deletion behavior
  validation:
    type: command-output
    command: 'echo "test" > /tmp/orig && ln /tmp/orig /tmp/hard && ln -s /tmp/orig
      /tmp/sym && \

      rm /tmp/orig && cat /tmp/hard 2>/dev/null && echo "hard_ok" || echo "hard_fail"

      '
    matcher: contains
    expected: hard_ok
- id: broken-symlinks
  title: Handle Broken Symbolic Links
  description: "**What is a Broken Symlink?**\n\nWhen a symlink points to a non-existent\
    \ target, it's \"broken\" or \"dangling.\"\n\n**Create a broken symlink:**\n\n\
    touch target.txt\nln -s target.txt link.txt\nrm target.txt\n\nNow link.txt is\
    \ broken!\n\n**Detecting Broken Symlinks:**\n\n1. ls shows them in red (with colors):\n\
    \   ls -l link.txt\n\n2. test -e returns false:\n   test -e link.txt && echo \"\
    exists\" || echo \"broken\"\n\n3. find command can locate them:\n   find ~ -type\
    \ l -xtype l\n\n   -type l = symbolic links\n   -xtype l = links whose target\
    \ is a link (broken)\n\n**Find All Broken Symlinks:**\nfind /home/learner -type\
    \ l ! -exec test -e {} \\; -print\n\nThis finds all symlinks (-type l) where the\
    \ target doesn't exist.\n\n**Fixing Broken Symlinks:**\n\nOption 1: Remove them\n\
    find ~ -type l -xtype l -delete\n\nOption 2: Update to new target\nln -sf new_target.txt\
    \ link.txt\n\n-f forces overwrite of existing link\n\n**Practice:**\nCreate several\
    \ symlinks, delete some targets, then find and fix broken links.\n"
  hint: 'Create symlink, delete target, use: find -type l ! -exec test -e {} \; -print'
  validation:
    type: command-output
    command: 'touch /tmp/t1 && ln -s /tmp/t1 /tmp/l1 && rm /tmp/t1 && \

      find /tmp -name l1 -type l ! -exec test -e {} \; -print | wc -l

      '
    matcher: contains
    expected: '1'
- id: relative-vs-absolute-symlinks
  title: Relative vs Absolute Symlinks
  description: "**Two Ways to Create Symlinks:**\n\n1. **Absolute Path** - Full path\
    \ from root\n   ln -s /home/learner/data/file.txt /tmp/link.txt\n\n2. **Relative\
    \ Path** - Path relative to link location\n   cd /tmp\n   ln -s ../home/learner/data/file.txt\
    \ link.txt\n\n**Which to Use?**\n\n**Absolute symlinks:**\n✓ Always work regardless\
    \ of current directory\n✓ Clear where they point\n✗ Break if files are moved as\
    \ a group\n✗ Not portable (hard-coded paths)\n\n**Relative symlinks:**\n✓ Portable\
    \ - work if entire directory moved\n✓ Better for version control\n✗ Can be confusing\
    \ (relative to link, not cwd)\n✗ Break if link moved without target\n\n**Best\
    \ Practice:**\n\nFor system-wide configs: Use absolute paths\nln -s /etc/nginx/sites-available/mysite\
    \ /etc/nginx/sites-enabled/\n\nFor project directories: Use relative paths\ncd\
    \ project/\nln -s ../shared/config.json config.json\n\n**View Link Target:**\n\
    readlink link.txt          # Shows exact path in link\nreadlink -f link.txt  \
    \     # Shows canonical absolute path\n\n**Practice:**\nCreate both types and\
    \ compare with readlink:\n\n# Absolute\nln -s /home/learner/data/file1.txt abs_link.txt\n\
    readlink abs_link.txt\n\n# Relative\nln -s data/file1.txt rel_link.txt\nreadlink\
    \ rel_link.txt\n\nMove the directory containing links and see which still works!\n"
  hint: Create with ln -s /full/path (absolute) or ln -s ../relative/path (relative)
  validation:
    type: command-output
    command: 'touch /tmp/target && ln -s /tmp/target /tmp/abs && \

      readlink /tmp/abs

      '
    matcher: contains
    expected: /tmp/target
- id: directory-symlinks
  title: Link to Directories - Only with Symlinks
  description: "**Directory Links:**\n\nHard links to directories are NOT allowed\
    \ (would create loops).\nOnly symbolic links can point to directories.\n\n**Create\
    \ Directory Symlink:**\n\nln -s /home/learner/projects /home/learner/proj\n\n\
    Now you can:\nls proj/web/         # Lists /home/learner/projects/web/\ncd proj/api/\
    \         # Changes to /home/learner/projects/api/\n\n**Common Use Cases:**\n\n\
    1. **Version management:**\n   ln -s /opt/app-1.2.0 /opt/app-current\n   # Update\
    \ by changing symlink, not moving files\n\n2. **Shared directories:**\n   ln -s\
    \ /mnt/storage/shared ~/shared\n\n3. **Simplified paths:**\n   ln -s /var/www/html/site/public\
    \ /var/www/site\n\n**Important Behavior:**\n\nWhen you cd into a symlinked directory:\n\
    cd proj/web/\npwd          # Shows /home/learner/proj/web (symlink path)\npwd\
    \ -P       # Shows /home/learner/projects/web (real path)\n\n-P = physical (follows\
    \ symlinks)\n\n**Deleting Directory Symlinks:**\n\n⚠️ CAREFUL:\nrm symlink_to_dir/\
    \     # Tries to delete directory contents!\nrm symlink_to_dir      # Removes\
    \ only the symlink ✓\n\nNever add trailing slash when removing directory symlinks!\n\
    \n**Practice:**\nCreate a symlink to projects/, navigate using it, check with\
    \ pwd and pwd -P.\n"
  hint: 'Create: ln -s projects/ proj, then cd proj && pwd && pwd -P'
  validation:
    type: command-output
    command: 'mkdir -p /tmp/realdir && ln -s /tmp/realdir /tmp/linkdir && \

      test -L /tmp/linkdir && echo "is_symlink" || echo "not_symlink"

      '
    matcher: contains
    expected: is_symlink
- id: disk-usage-du
  title: Analyze Disk Usage with du
  description: '**The du Command - Disk Usage:**


    du estimates file space usage.


    **Basic Usage:**

    du -h data/              # Human-readable sizes

    du -sh data/             # Summary only (-s)

    du -ah data/             # All files, not just directories


    **Find Large Directories:**


    Sort by size to find space hogs:

    du -h data/ | sort -rh | head -n 10


    -rh = reverse, human-readable sort


    **Options:**


    -c  : Show grand total

    -s  : Summary only (don''t show subdirectories)

    -h  : Human-readable (KB, MB, GB)

    -d N: Max depth N levels

    -a  : Include files, not just directories


    **Find Largest Items:**


    Top 10 largest directories in home:

    du -h ~ | sort -rh | head -n 10


    Specific depth only:

    du -h --max-depth=1 ~ | sort -rh


    **Disk Usage vs File Size:**


    du shows DISK USAGE (blocks allocated)

    ls -l shows FILE SIZE (actual content)


    These differ due to:

    - Block size (minimum allocation unit)

    - Sparse files (holes)

    - Compression


    **Hard Links and du:**


    Hard links count only ONCE:

    echo "data" > file1.txt

    ln file1.txt file2.txt

    du -sh file*.txt

    # Shows size once, not twice!


    **Practice:**

    Find the largest directories in your home directory using du + sort.

    '
  hint: 'Use: du -h ~ | sort -rh | head -n 10'
  validation:
    type: command-output
    command: du -sh /home/learner 2>/dev/null | awk '{print $1}' | grep -E '[0-9]+[KMG]'
    matcher: contains
    expected: ''
- id: disk-space-df
  title: Check Filesystem Space with df
  description: '**The df Command - Disk Free:**


    df reports filesystem disk space usage (mounted filesystems).


    **Basic Usage:**

    df -h              # All filesystems, human-readable

    df -h /home        # Specific mount point

    df -i              # Show inode usage instead of blocks


    **Output Columns:**

    Filesystem   Size  Used  Avail  Use%  Mounted on

    /dev/sda1    50G   30G   18G    63%   /


    **Key Differences: df vs du**


    df:

    - Shows filesystem level (partitions/mounts)

    - Fast (reads superblock only)

    - Shows total, used, available space

    - Shows mount points


    du:

    - Shows directory/file level

    - Slow (traverses all files)

    - Shows usage of specific paths

    - More detailed


    **Inode Usage:**


    Filesystems have limited inodes (file metadata slots).

    Can run out of inodes even with free space!


    df -i         # Check inode usage


    IUse% column shows inode usage percentage.


    **Find Filesystem for a File:**

    df -h /home/learner/data/file1.txt


    Shows which filesystem contains that file.


    **Practical Monitoring:**


    Check if running out of space:

    df -h | grep -vE ''tmpfs|udev'' | awk ''$5 > 80 {print $0}''


    This shows filesystems over 80% full.


    **Practice:**

    Check all filesystem space, identify which filesystem your home is on.

    '
  hint: 'Use: df -h | grep /home or df -h ~'
  validation:
    type: command-output
    command: df -h / | tail -n 1 | awk '{print $5}' | grep -E '[0-9]+%'
    matcher: contains
    expected: '%'
- id: practical-scenarios
  title: Apply Knowledge to Real Scenarios
  description: "**Scenario 1: Safe Backup with Hard Links**\n\nIncremental backup\
    \ without duplicating unchanged files:\n\n# Full backup\ncp -al /source/dir /backup/backup-2026-01-01\n\
    \n# Next day - changed files only\nrsync -a --link-dest=/backup/backup-2026-01-01\
    \ \\\n      /source/dir /backup/backup-2026-01-02\n\nUnchanged files are hard-linked\
    \ (save space).\nChanged files are copied.\n\n**Scenario 2: Version Management\
    \ with Symlinks**\n\nManaging application versions:\n\n/opt/myapp-1.0/\n/opt/myapp-1.1/\n\
    /opt/myapp-1.2/\n/opt/myapp -> myapp-1.2    # Current version symlink\n\nTo update:\n\
    ln -sfn myapp-1.2 /opt/myapp\n\nAll scripts use /opt/myapp (never changes).\n\n\
    **Scenario 3: Shared Libraries**\n\nSystem libraries use symlinks:\n\nlibpython3.10.so.1.0\
    \       # Actual file\nlibpython3.10.so.1 -> libpython3.10.so.1.0\nlibpython3.so\
    \ -> libpython3.10.so.1\n\nMultiple symlinks for compatibility.\n\n**Scenario\
    \ 4: Disk Space Investigation**\n\nFind what's using space:\n\n# Large directories\n\
    du -sh /* 2>/dev/null | sort -rh | head -n 10\n\n# Large files\nfind / -type f\
    \ -size +100M -exec ls -lh {} \\; 2>/dev/null\n\n# Old log files\nfind /var/log\
    \ -type f -mtime +30 -ls\n\n**Scenario 5: Broken Symlink Cleanup**\n\nClean up\
    \ broken links in a project:\n\nfind ~/projects -type l -xtype l -delete\n\nOr\
    \ find and review first:\nfind ~/projects -type l -xtype l -ls\n\n**Practice:**\n\
    Implement one of these scenarios in your environment!\n"
  hint: Try creating version symlinks or finding large files with find + du
  validation:
    type: command-output
    command: 'mkdir -p /tmp/v1 /tmp/v2 && ln -sfn v2 /tmp/current && \

      readlink /tmp/current

      '
    matcher: contains
    expected: v2
completion:
  message: "\U0001F393 FILESYSTEM INTERNALS MASTERED! \U0001F393\n\nYou've completed\
    \ an advanced deep-dive into Linux filesystem internals!\n\n**Concepts Mastered:**\n\
    \n✓ **Inodes** - The filesystem's metadata structures\n  - Inode numbers identify\
    \ files\n  - Filenames are separate from inodes\n  - Multiple names can point\
    \ to same inode\n\n✓ **Hard Links** - Multiple names, same file\n  - Share the\
    \ same inode\n  - All names are equals\n  - File deleted only when all links removed\n\
    \  - Cannot span filesystems\n  - Cannot link to directories\n\n✓ **Symbolic Links**\
    \ - Pointers to paths\n  - Have their own inodes\n  - Contain path to target file\n\
    \  - Can link to directories\n  - Can span filesystems\n  - Can be broken if target\
    \ deleted\n  - Relative vs absolute paths\n\n✓ **Disk Usage Analysis**\n  - du:\
    \ Directory/file level usage\n  - df: Filesystem level usage\n  - Finding large\
    \ files and directories\n  - Inode usage monitoring\n\n**Practical Skills:**\n\
    \n☑ Create and manage hard links\n☑ Create and manage symbolic links\n☑ Find and\
    \ fix broken symlinks\n☑ Analyze disk usage patterns\n☑ Implement versioning with\
    \ symlinks\n☑ Space-efficient backups with hard links\n☑ Debugging filesystem\
    \ issues\n\n**Real-World Applications:**\n\n- Incremental backups (rsync + hard\
    \ links)\n- Application version management\n- Shared library systems\n- Disk space\
    \ optimization\n- Configuration management\n- Development environment setup\n\n\
    **Commands You've Mastered:**\n\n- ls -i, ls -l (view inodes and links)\n- stat\
    \ (detailed file information)\n- ln (create hard links)\n- ln -s (create symbolic\
    \ links)\n- readlink (show link targets)\n- find -type l (find symlinks)\n- du\
    \ (disk usage)\n- df (filesystem space)\n\nYou now understand how Linux filesystems\
    \ work at a deep level!\nThis knowledge is essential for:\n- System administration\n\
    - DevOps automation\n- Storage management\n- Performance optimization\n- Backup\
    \ strategies\n\n**Next Steps:**\n- Learn about advanced filesystem features (quotas,\
    \ ACLs)\n- Explore filesystem types (ext4, xfs, btrfs)\n- Study RAID and LVM\n\
    - Practice with production scenarios\n\nEXCELLENT WORK on completing this advanced\
    \ mission!\n"
  xp: 600
  unlocks:
  - linux/week7/practice-disk-optimization
  - linux/week9/process-management-advanced
