mission:
  id: "linux/week10/cron-advanced"
  title: "Advanced Cron Job Scheduling"
  difficulty: advanced
  description: "Master advanced cron features including special strings, system-wide cron, error handling, and monitoring"
  estimated_time: 45
  tags:
    - linux
    - cron
    - automation
    - advanced
    - week10
    - cst8207

environment:
  image: "ubuntu:22.04"
  workdir: "/home/learner"
  setup:
    - "apt-get update -qq && apt-get install -y -qq cron rsyslog anacron at mailutils"
    - "service cron start"
    - "service rsyslog start"
    - "mkdir -p /home/learner/scripts /home/learner/logs /etc/cron.d"
    - |
      cat > /home/learner/scripts/backup.sh << 'EOF'
      #!/bin/bash
      echo "[$(date)] Starting backup..."
      if [ -d "/home/learner/data" ]; then
        tar -czf /home/learner/backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz /home/learner/data/ 2>/dev/null
        echo "[$(date)] Backup completed successfully"
        exit 0
      else
        echo "[$(date)] ERROR: Data directory not found" >&2
        exit 1
      fi
      EOF
    - "chmod +x /home/learner/scripts/backup.sh"
    - "mkdir -p /home/learner/data /home/learner/backups"
    - "echo 'Sample data' > /home/learner/data/file1.txt"

steps:
  - id: "special-strings"
    title: "Special Cron Time Strings"
    description: |
      **Cron Special Strings:**

      Instead of "* * * * *", use readable shortcuts!

      **Available special strings:**

      @reboot        Run once at startup
      @yearly        Run once a year  (0 0 1 1 *)
      @annually      Same as @yearly
      @monthly       Run once a month (0 0 1 * *)
      @weekly        Run once a week  (0 0 * * 0)
      @daily         Run once a day   (0 0 * * *)
      @midnight      Same as @daily
      @hourly        Run once an hour (0 * * * *)

      **Examples:**

      Daily backup at midnight:
      @daily /home/learner/scripts/backup.sh

      Instead of:
      0 0 * * * /home/learner/scripts/backup.sh

      **Advantages:**
      - More readable
      - Less error-prone
      - Self-documenting
      - Easier maintenance

      **Add a daily job:**
      (crontab -l 2>/dev/null; echo "@daily /home/learner/scripts/backup.sh >> /home/learner/logs/backup.log 2>&1") | crontab -

      **Verify:**
      crontab -l

      Much cleaner than "0 0 * * *"!
    hint: "Add daily job using @daily special string"
    validation:
      type: "command-output"
      command: "(crontab -l 2>/dev/null; echo '@daily /tmp/test.sh') | crontab - && crontab -l | grep '@daily'"
      matcher: "contains"
      expected: "@daily"

  - id: "system-wide-cron"
    title: "System-Wide Cron Jobs"
    description: |
      **System Cron vs User Cron:**

      **User Crontab:**
      - Per-user: crontab -e
      - Runs as that user
      - Location: /var/spool/cron/crontabs/

      **System-Wide Cron:**
      - For all users and system tasks
      - Requires root/sudo access
      - Multiple locations

      **System Cron Locations:**

      1. **/etc/crontab** - Main system crontab
         Format: minute hour day month dow USER command
         Note: Includes username field!

      2. **/etc/cron.d/** - Drop-in cron files
         - Each file is a separate crontab
         - Used by packages and services
         - Same format as /etc/crontab

      3. **Convenience directories:**
         - /etc/cron.hourly/   - Scripts run hourly
         - /etc/cron.daily/    - Scripts run daily
         - /etc/cron.weekly/   - Scripts run weekly
         - /etc/cron.monthly/  - Scripts run monthly

      **System crontab format:**
      ```
      # minute hour day month dow user command
      30 2 * * * root /usr/local/bin/backup.sh
      ```

      **View system crontab:**
      cat /etc/crontab

      **List system cron directories:**
      ls -la /etc/cron.*

      **Explore system cron:**
      cat /etc/crontab
      ls /etc/cron.d/
    hint: "View /etc/crontab to see system-wide cron configuration"
    validation:
      type: "command-output"
      command: "cat /etc/crontab 2>/dev/null || echo 'SHELL'"
      matcher: "contains"
      expected: "SHELL"

  - id: "create-system-cron"
    title: "Create System Cron Job"
    description: |
      **Creating System Cron Jobs:**

      System cron files in /etc/cron.d/ allow:
      - Package-specific schedules
      - Multi-user jobs
      - Isolated configurations

      **Format rules for /etc/cron.d/:**
      1. Must include username field
      2. No file extension or only alphanumeric + hyphen/underscore
      3. Must be owned by root
      4. Not group or world writable

      **Create a system cron job:**

      Create file: /etc/cron.d/system-maintenance

      Content:
      ```
      # System maintenance tasks
      SHELL=/bin/bash
      PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

      # Clean temp files daily at 3 AM
      0 3 * * * root find /tmp -type f -mtime +7 -delete

      # Update package lists weekly
      0 4 * * 0 root apt-get update -qq
      ```

      **Important:**
      - Include SHELL and PATH
      - Comment your jobs
      - Specify user (root or specific user)

      **Create a maintenance cron file:**
      sudo cat > /etc/cron.d/learner-tasks << 'EOF'
      # Learner automated tasks
      SHELL=/bin/bash
      PATH=/usr/local/bin:/usr/bin:/bin

      # Backup every 6 hours
      0 */6 * * * learner /home/learner/scripts/backup.sh >> /home/learner/logs/backup.log 2>&1
      EOF

      Note: In a real system, use sudo. Here we'll simulate.
    hint: "Create a cron file in /etc/cron.d/ with proper format"
    validation:
      type: "command-output"
      command: "echo '0 */6 * * * learner /tmp/test.sh' | grep -E '^[0-9].*learner'"
      matcher: "contains"
      expected: "learner"

  - id: "cron-environment"
    title: "Advanced Environment Configuration"
    description: |
      **Cron Environment Variables:**

      Cron runs with minimal environment. Set variables at top of crontab.

      **Essential variables:**

      **PATH** - Where to find commands
      PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin

      **SHELL** - Shell to use for commands
      SHELL=/bin/bash

      **MAILTO** - Email address for output
      MAILTO=admin@example.com
      MAILTO=""  # Disable email

      **HOME** - Home directory
      HOME=/home/learner

      **LANG** - Locale settings
      LANG=en_US.UTF-8

      **Custom variables:**
      BACKUP_DIR=/var/backups
      LOG_LEVEL=INFO

      **Example crontab with environment:**
      ```
      # Environment
      SHELL=/bin/bash
      PATH=/usr/local/bin:/usr/bin:/bin
      MAILTO=admin@example.com
      BACKUP_DIR=/var/backups

      # Jobs
      @daily $BACKUP_DIR/backup.sh
      ```

      **Best practices:**
      - Always set PATH explicitly
      - Use absolute paths in commands
      - Set MAILTO or redirect output
      - Document custom variables

      **Update your crontab with environment:**
      (crontab -l 2>/dev/null | grep -v "^PATH\|^SHELL"; echo "PATH=/usr/local/bin:/usr/bin:/bin"; echo "SHELL=/bin/bash"; crontab -l 2>/dev/null | grep -v "^PATH\|^SHELL") | crontab -
    hint: "Add PATH and SHELL variables to your crontab"
    validation:
      type: "command-output"
      command: "echo -e 'PATH=/usr/bin:/bin\\nSHELL=/bin/bash\\n@daily /tmp/test' | crontab - && crontab -l | grep 'PATH='"
      matcher: "contains"
      expected: "PATH="

  - id: "error-handling"
    title: "Cron Job Error Handling"
    description: |
      **Handling Cron Job Failures:**

      Cron jobs fail silently. Implement proper error handling!

      **Strategy 1: Exit Codes**

      Scripts should return proper exit codes:
      ```bash
      #!/bin/bash
      if command_succeeds; then
        exit 0  # Success
      else
        exit 1  # Failure
      fi
      ```

      **Strategy 2: Logging**

      Always log output:
      ```
      * * * * * /script.sh >> /var/log/script.log 2>&1
      ```

      **Strategy 3: Email Notifications**

      Set MAILTO:
      ```
      MAILTO=admin@example.com
      * * * * * /script.sh
      ```

      Or use mail command:
      ```bash
      if ! /script.sh; then
        echo "Script failed" | mail -s "Cron Failure" admin@example.com
      fi
      ```

      **Strategy 4: Wrapper Script**

      Create error-handling wrapper:
      ```bash
      #!/bin/bash
      LOG="/var/log/cron_wrapper.log"
      SCRIPT="$1"

      echo "[$(date)] Running $SCRIPT" >> "$LOG"
      if $SCRIPT >> "$LOG" 2>&1; then
        echo "[$(date)] SUCCESS" >> "$LOG"
      else
        echo "[$(date)] FAILED (exit $?)" >> "$LOG"
        # Send alert
      fi
      ```

      **Strategy 5: Monitoring with chronic**

      chronic (from moreutils) only outputs on failure:
      ```
      * * * * * chronic /script.sh
      ```

      **Create an error-logging wrapper:**

      cat > /home/learner/scripts/cron_wrapper.sh << 'EOF'
      #!/bin/bash
      LOG="/home/learner/logs/cron_wrapper.log"
      SCRIPT="$1"

      echo "[$(date)] Executing: $SCRIPT" >> "$LOG"
      if $SCRIPT >> "$LOG" 2>&1; then
        echo "[$(date)] âœ“ Success" >> "$LOG"
        exit 0
      else
        EXIT_CODE=$?
        echo "[$(date)] âœ— Failed with exit code $EXIT_CODE" >> "$LOG"
        exit $EXIT_CODE
      fi
      EOF

      chmod +x /home/learner/scripts/cron_wrapper.sh
    hint: "Create a wrapper script that logs execution and captures errors"
    validation:
      type: "file-exists"
      path: "/home/learner/scripts/cron_wrapper.sh"

  - id: "cron-logging"
    title: "Monitor Cron Execution"
    description: |
      **Finding Cron Logs:**

      Cron logs to syslog. Location varies by distribution.

      **Common log locations:**
      - Ubuntu/Debian: /var/log/syslog
      - RHEL/CentOS: /var/log/cron
      - systemd: journalctl -u cron

      **View cron logs:**
      grep CRON /var/log/syslog

      **Look for:**
      - Job execution: "CMD (/path/to/command)"
      - Errors: "ERROR" or "FAILED"
      - Crontab updates: "REPLACE" or "LIST"

      **Filter cron activity:**

      Today's cron jobs:
      grep CRON /var/log/syslog | tail -50

      Specific user:
      grep "CRON.*learner" /var/log/syslog

      Failed jobs:
      grep -i "cron.*error" /var/log/syslog

      Crontab changes:
      grep "crontab" /var/log/syslog

      **With systemd:**
      journalctl -u cron --since today
      journalctl -u cron -f  # Follow in real-time

      **Check recent cron activity:**
      grep CRON /var/log/syslog 2>/dev/null | tail -20

      Or:
      journalctl -u cron --no-pager --since "1 hour ago" 2>/dev/null
    hint: "Search for CRON in syslog to see execution history"
    validation:
      type: "command-output"
      command: "grep CRON /var/log/syslog 2>/dev/null || journalctl -u cron --no-pager -n 5 2>/dev/null || echo 'CRON'"
      matcher: "contains"
      expected: "CRON"

  - id: "anacron-basics"
    title: "Introduction to Anacron"
    description: |
      **Anacron: For Inconsistent Uptime**

      **Problem with cron:**
      If system is off at scheduled time, job is SKIPPED.

      Example: Laptop scheduled for 3 AM backup
      - Laptop off at 3 AM â†’ backup never runs
      - Next day off again â†’ backup still never runs

      **Anacron solution:**
      Runs missed jobs when system starts up!

      **Anacron vs Cron:**

      | Feature | Cron | Anacron |
      |---------|------|---------|
      | Precision | Minute | Day |
      | When | Exact time | At system start |
      | Use case | Servers | Laptops/desktops |
      | Min frequency | Every minute | Daily |

      **Anacron configuration:**
      File: /etc/anacrontab

      Format:
      ```
      period delay job-id command
      ```

      period = days between runs
      delay = minutes to wait after boot
      job-id = unique identifier
      command = what to run

      **Example /etc/anacrontab:**
      ```
      # period delay job-id command
      1       5     cron.daily    run-parts /etc/cron.daily
      7       10    cron.weekly   run-parts /etc/cron.weekly
      @monthly 15   cron.monthly  run-parts /etc/cron.monthly
      ```

      **How it works:**
      1. System boots
      2. Anacron checks last run timestamps
      3. If job is overdue, waits delay minutes
      4. Runs the job
      5. Updates timestamp

      **View anacron config:**
      cat /etc/anacrontab

      **Check anacron timestamps:**
      ls -l /var/spool/anacron/
    hint: "View /etc/anacrontab to see anacron configuration"
    validation:
      type: "command-output"
      command: "cat /etc/anacrontab 2>/dev/null || echo 'anacron'"
      matcher: "contains"
      expected: "anacron"

  - id: "at-command"
    title: "One-Time Scheduling with at"
    description: |
      **The at Command: One-Time Jobs**

      Unlike cron (recurring), at runs a command ONCE at a specific time.

      **Basic usage:**
      at <time>
      at> <command>
      at> <Ctrl+D>

      **Time formats:**

      Absolute:
      at 10:30 AM
      at 14:00
      at 2:00 PM tomorrow
      at 10:00 AM 12/25/2026

      Relative:
      at now + 5 minutes
      at now + 2 hours
      at now + 3 days
      at now + 1 week

      Named times:
      at noon
      at midnight
      at teatime  # 4 PM

      **Example session:**
      ```bash
      $ at now + 5 minutes
      at> echo "Task completed" >> /home/learner/logs/at.log
      at> <Ctrl+D>
      job 1 at Thu Jan  9 15:35:00 2026
      ```

      **Manage at jobs:**

      atq           # List pending jobs
      at -l         # Same as atq
      atrm <job>    # Remove job
      at -c <job>   # Show job details

      **Schedule a test job:**

      echo "echo 'Hello from at' >> /home/learner/logs/at.log" | at now + 1 minute

      **List queued jobs:**
      atq

      You should see your scheduled job!

      **When to use at vs cron:**
      - at: One-time future task
      - cron: Recurring scheduled task
    hint: "Use: echo 'command' | at now + 1 minute"
    validation:
      type: "command-output"
      command: "echo 'echo test' | at now + 1 minute 2>&1 && atq"
      matcher: "contains"
      expected: ""

  - id: "cron-security"
    title: "Cron Security Considerations"
    description: |
      **Securing Cron Jobs:**

      **1. Access Control:**

      **/etc/cron.allow** - Users allowed to use cron
      - If exists, ONLY listed users can use cron
      - One username per line

      **/etc/cron.deny** - Users denied cron access
      - If exists (and no cron.allow), listed users can't use cron
      - If neither exists, all users can use cron (default)

      Example cron.allow:
      ```
      root
      admin
      backup
      ```

      **2. File Permissions:**

      Cron files should be:
      - Owned by root (system cron)
      - Not world-writable
      - Readable only by owner

      Check system cron permissions:
      ls -la /etc/cron.d/
      ls -la /etc/cron.daily/

      **3. Script Security:**

      âœ“ Use absolute paths
      âœ— /bin/ls (safer)
      âœ“ ls (could be trojaned in PATH)

      âœ“ Validate inputs
      âœ— rm -rf $DIR/* (if $DIR empty, deletes everything!)
      âœ“ rm -rf "${DIR:?}/" * (fails if $DIR empty)

      âœ“ Set secure PATH
      PATH=/usr/local/bin:/usr/bin:/bin

      âœ“ Check file existence
      ```bash
      if [ -f "$FILE" ]; then
        cat "$FILE"
      fi
      ```

      **4. Output Security:**

      Don't log sensitive data:
      âœ— echo "Password: $PASS" >> log
      âœ“ echo "Login attempt" >> log

      Secure log permissions:
      chmod 600 /var/log/sensitive.log

      **5. Environment:**

      Don't trust inherited environment:
      - Set PATH explicitly
      - Set HOME explicitly
      - Unset unnecessary variables

      **Check cron security:**
      ls -la /etc/cron.allow /etc/cron.deny 2>/dev/null || echo "No access control files"
      ls -ld /etc/cron.d/
    hint: "Check for cron access control files and directory permissions"
    validation:
      type: "command-output"
      command: "ls -ld /etc/cron.d/ | awk '{print $1}'"
      matcher: "contains"
      expected: "d"

  - id: "cron-debugging"
    title: "Debug Cron Job Issues"
    description: |
      **Common Cron Problems and Solutions:**

      **Problem 1: Job doesn't run**

      Checklist:
      â˜ Is cron service running?
         service cron status

      â˜ Is syntax correct?
         Use crontab generators online

      â˜ Is script executable?
         chmod +x /path/to/script.sh

      â˜ Does script work manually?
         /path/to/script.sh

      â˜ Check cron logs
         grep CRON /var/log/syslog

      **Problem 2: Job runs but fails**

      Checklist:
      â˜ Check script's exit code
      â˜ Add logging: >> /tmp/debug.log 2>&1
      â˜ Check permissions on files script accesses
      â˜ Verify PATH contains needed commands
      â˜ Use absolute paths

      **Problem 3: Environment issues**

      Debug wrapper:
      ```bash
      #!/bin/bash
      # Log entire environment
      env > /tmp/cron_env.txt
      # Run with -x for debugging
      bash -x /path/to/script.sh > /tmp/debug.log 2>&1
      ```

      **Problem 4: Output not appearing**

      Check:
      â˜ Is output redirected correctly?
      â˜ Does log directory exist?
      â˜ Are permissions correct on log file?
      â˜ Is disk full? (df -h)

      **Debugging technique:**

      Create minimal test job:
      ```
      * * * * * echo "Test $(date)" >> /tmp/cron_test.log 2>&1
      ```

      Wait 2 minutes, check:
      cat /tmp/cron_test.log

      If this works, issue is with your script, not cron.

      **Test cron functionality:**
      echo "* * * * * echo 'Cron works: \$(date)' >> /tmp/cron_debug.log 2>&1" | crontab -

      Wait 2 minutes:
      cat /tmp/cron_debug.log
    hint: "Create a simple test cron job that logs to debug issues"
    validation:
      type: "command-output"
      command: "echo '* * * * * echo test >> /tmp/test.log 2>&1' | crontab - && crontab -l | grep 'test'"
      matcher: "contains"
      expected: "test"

completion:
  message: |
    ğŸ‰ ADVANCED CRON MASTERED! ğŸ‰

    You've mastered advanced cron scheduling and automation!

    **What You've Learned:**

    âœ“ Special cron strings (@daily, @reboot, etc.)
    âœ“ System-wide cron (/etc/crontab, /etc/cron.d/)
    âœ“ Creating system cron jobs
    âœ“ Advanced environment configuration
    âœ“ Error handling and logging strategies
    âœ“ Monitoring cron execution
    âœ“ Anacron for irregular schedules
    âœ“ at command for one-time jobs
    âœ“ Cron security best practices
    âœ“ Debugging cron job issues

    **Special Strings:**
    @reboot   @yearly   @monthly   @weekly
    @daily    @hourly

    **System Cron Locations:**
    /etc/crontab       - Main system crontab
    /etc/cron.d/       - Drop-in cron files
    /etc/cron.daily/   - Daily scripts
    /etc/cron.weekly/  - Weekly scripts
    /etc/cron.monthly/ - Monthly scripts

    **Error Handling Strategies:**
    â˜‘ Use proper exit codes
    â˜‘ Redirect all output to logs
    â˜‘ Implement wrapper scripts
    â˜‘ Monitor with syslog
    â˜‘ Send notifications on failure

    **Security Best Practices:**
    â˜‘ Use absolute paths
    â˜‘ Set secure PATH
    â˜‘ Validate inputs
    â˜‘ Secure file permissions
    â˜‘ Limit cron access with cron.allow

    **Debugging Checklist:**
    â˜ Service running?
    â˜ Syntax correct?
    â˜ Script executable?
    â˜ Works manually?
    â˜ Check logs?
    â˜ Environment correct?

    **Commands Mastered:**
    cron:    crontab -l, -e, -r
    logs:    grep CRON /var/log/syslog
    anacron: anacron -T, -f
    at:      at, atq, atrm
    system:  service cron status/restart

    **When to Use What:**
    - cron: Regular recurring tasks
    - anacron: Desktop/laptop periodic tasks
    - at: One-time future tasks
    - systemd timers: Modern alternative to cron

    You can now build robust automated task systems!

    Next: Expert-level practice with comprehensive automation!
  xp: 500
  unlocks:
    - "linux/week10/practice-backup-automation"
    - "linux/week11/shell-scripting-beginner"
